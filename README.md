## zhuOS

### 启动
接电一瞬间，CPU 寄存器强制初始化到 BIOS 的入口地址 0xffff0，这个地址是只读 ROM 固化的硬盘中的 BIOS 程序，随后 BIOS 开始对计算机各个部件进行初始化，报告错误。完成这些工作后，BIOS 开始在启动设备表中寻找可启动设备 mbr,一般 mbr 存放在 0 盘 0 道 1 扇区，末尾由 0x55 和 0xaa 标识。找到该设备后，BIOS 将 mbr.bin 加载到硬盘的第一个扇区0x7c00 处。一个扇区只有 512 字节，无法为内核准备好环境，所以 mbr 会将 loader 从硬盘加载到内存。loader 负责完成初始化环境能够以及加载内核的任务。

#### loader职责
- 利用 BIOS 中断e820、e801、88 获取物理内存总量
- 进入保护模式：打开 A20 地址总线、在 gdtr 寄存器中加载 GDT 地址及偏移量、将 cr0 寄存器第 0 位置 1
- 启用分页机制，追备好也目录项和页表，将页表写入控制寄存器，寄存器 cr0 的 PG 位置 1
- 加载内核
    - 将内核文件加载到内存缓冲区
    - 初始化内核，在分页后，将加载进来的 elf 内核文件安置到相应的虚拟内存地址，然后跳过去执行，loader工作结束

#### 全局描述符表 GDT
- 保护模式下内存段不再是简单的用段寄存器加载段基址就能直接用，段中添加了很多其他信息，如段界限、段读写权限、段特权级等，这些信息定义在段描述符中，段描述符定义在段描述符表中，一个段描述符只用来定义一个内存段
- 全局描述符表 GDT 是保护模式下内存段的登记表，存在于内存中，有专门的寄存器 GDTR 指向他。GDT 相当于描述符的数组，数组中的每个元素都是 8 字节的描述符
- 段寄存器中存放的是选择子，选择子的高 13 位，第 3～15 位是描述符的索引值，用此值在 GDT 中索引描述符，相当于 GDT 的下标。选择子的作用主要是确定段描述符
- 描述符表包括全局描述符表和局部描述符表，全局描述符表每个 CPU 只有一个，因为全局描述附表存内存中。Linux 内存模式为平坦模式，即所有段描述符中的段基址为全 0，段界限为全 1，这样只需不同特权级的任务有不同的数据段描述符、代码段描述符(读写权限不同)
  
### 中断
中断是指 CPU 暂停正在执行的程序，转而去执行处理其他事件的程序，当这段程序执行完毕后，CPU 继续执行刚才的程序。中断是提升整个系统利用率最有效的方式
- 中断分为外部中断和内部中断。

#### 外部中断
外部中断又称为硬件中断，中断源必须是某个硬件。外部中断又分为可屏蔽中断和不可屏蔽中断。
- 可屏蔽中断指的是可以通过 eflags 寄存器的 IF 位将这些外部设备中断屏蔽。这类中断 CPU 可以选择不用理会，也可以把中断分为上半部分和下半部分来处理。上半部分是需要立即执行无法耽误的事情，所以上半部是在关中断不被打扰的情况下执行的。当上半部执行完成后就把中断打开了，下半部也属于中断处理程序，所以中断处理程序下半部则是在开中断的情况下执行的，如果有新的中断发生，原来这个旧中断的下半部就会被换下 CPU，先执行新的中断处理程序的上半部，等待线程调度机制为旧中断处理程序择一日期（就是指调度算法认为的某个恰当时机）后，再调度其上 CPU 完成其下半部的执行。
- 不可屏蔽中断是“即将宕机”的中断，CPU 收到此中断后，通过在中断描述符表中查询相应的中断向量号检索对应的中断处理程序去执行

#### 内部中断
内部中断可分为软中断和异常。
- 软中断是由软件主动发起的中断，中断指令有“int 8位立即数”、“int3”（调试断点指令）等，int n型的软中断用于实现系统调用功能，无视IF位
- 异常分为三种，Fault故障（可修复，最轻的异常，比如page fault）、Trap陷阱、Abort终止（最严重的异常类型，操作系统为了自保会将此程序从进程表中去掉）

#### 中断描述符表IDT
中断描述符表是保护模式下用于存储中断处理程序入口的表，当 CPU 接收一个中断时，需要用中断向量在此表中检索对应的描述符，在该描述符中找到中断处理程序的起始地址，然后执行中断处理程序

### 文件系统
- 每个文件都有自己单独的 inode，inode 是文件实体数据块在文件系统上的元信息
- 所有文件的 inode 集中管理，形成 inode 数组，每个 inode 编号就是在该 inode 数组中的下标
- inode 中的前 12 个直接数据块指针和后 3 个间接块索引表用于指向文件的数据块实体
- 文件系统中并不存在具体称为“目录”的数据结构,同样也没有称为“普通文件”数据结构,统一用同一种 inode 表示。inode 表示的文件是普通文件,还是目录文件，取决于 inode 所指向数据块中的实际内容是什么,即数据块中的内容要么是普通文件本身的数据,要么是目录中的目录项
- 目录项仅存在于 inode 指向的数据块中,有目录项的数据块就是目录,目录项所属的 inode 指向的所有数据块便是目录
- 目录项中记录的是文件名、文件 inode 的编号和文件类型,目录项起到的作用有两个，一是粘合文件名及 inode,使文件名和 inode 关联绑定,二是标识此 inode 所指向的数据块中的数据类型(比如是普通文件,还是目录,当然还有更多的类型)
- inode 是文件的“实质”,但它并不能直接引用,必须通过文件名找到文件名所在的目录项,然后从该目录项中获得 inode 的编号,然后用此编号到 inode 数组中去找相关的 inode,最终找到文件的数据块。
- super block负责保存文件系统元信息的元信息：inode数组的地址及大小、inode位图地址及大小、根目录的地址和大小、空闲块位图的地址和大小。super block被固定存储在各分区的第二个扇区
- 在操作系统引导块mbr后面的依次是：超级块、空闲块的位图、inode 位图、inode 数组、根目录、空闲块区域
